<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Profil - Sabot Invest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        padding-bottom: 100px; /* Espace pour la navbar */
    }

    /* --- Header Premium avec Dégradé --- */
    .header-bg {
        background: linear-gradient(135deg, #4B0082, #800080);
        height: 180px;
        border-radius: 0 0 30px 30px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(75, 0, 130, 0.3);
    }
    
    .header-title {
        color: #fff;
        font-size: 22px;
        font-weight: bold;
        margin-top: -40px;
    }

    /* --- Carte Profil Flottante --- */
    .profile-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        width: 85%;
        max-width: 500px;
        margin: -60px auto 20px auto; /* Remonte sur le header */
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
    }

    .avatar-circle {
        width: 80px;
        height: 80px;
        background: #f3e5f5;
        border-radius: 50%;
        margin: 0 auto 15px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .avatar-circle i { font-size: 35px; color: #6a0dad; }

    .user-phone { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .user-badge { 
        background: linear-gradient(45deg, #ffd700, #ffb900);
        color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
    }

    /* --- Section Invitation --- */
    .invite-section {
        margin-top: 25px;
        background: #fafafa;
        padding: 15px;
        border-radius: 15px;
        border: 1px dashed #6a0dad;
    }
    .invite-label { font-size: 13px; color: #777; margin-bottom: 8px; display: block; }
    .code-display {
        font-size: 24px;
        font-weight: bold;
        color: #4B0082;
        letter-spacing: 2px;
        margin-bottom: 15px;
        display: block;
    }
    .action-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 15px;
        transition: transform 0.2s;
    }
    .btn-copy { background: #6a0dad; color: #fff; box-shadow: 0 4px 10px rgba(106, 13, 173, 0.3); }
    .btn-copy:active { transform: scale(0.98); }

    /* --- Boutons Support (Grid) --- */
    .support-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
    }
    .btn-whatsapp { background: #25D366; color: #fff; }
    .btn-telegram { background: #0088cc; color: #fff; }
    .btn-logout { background: #ffebee; color: #d32f2f; margin-top: 10px; width: 100%; }

    /* --- Tableau Filleuls --- */
    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #333;
        margin: 30px 0 15px 0;
        padding-left: 20px;
        border-left: 4px solid #6a0dad;
    }

    .table-container {
        background: #fff;
        margin: 0 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; color: #666; font-size: 12px; text-transform: uppercase; padding: 12px 15px; text-align: left; }
    td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
    tr:last-child td { border-bottom: none; }
    
    .status-dot { height: 8px; width: 8px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .money-col { font-weight: bold; color: #2ecc71; }

    /* --- Navbar --- */
    .navbar {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 600px;
        background: rgba(106, 13, 173, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 50px;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    .navbar a { color: #fff; font-size: 20px; text-decoration: none; display: flex; flex-direction: column; align-items: center; opacity: 0.7; transition: 0.3s; }
    .navbar a span { font-size: 10px; margin-top: 4px; font-weight: 500; }
    .navbar a.active { opacity: 1; color: #ffd700; transform: translateY(-2px); }

    /* Modal de copie */
    .toast {
        visibility: hidden;
        min-width: 200px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 50px;
        padding: 12px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        transform: translateX(-50%);
        bottom: 90px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 100px; }

</style>
</head>
<body>

    <div class="header-bg">
        <div class="header-title">Mon Espace</div>
    </div>

    <div class="profile-card">
        <div class="avatar-circle">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-phone" id="userPhone">Chargement...</div>
        <span class="user-badge"><i class="fas fa-crown"></i> Membre VIP</span>

        <div class="invite-section">
            <span class="invite-label">Votre Code d'Invitation</span>
            <span class="code-display" id="myReferralCode">...</span>
            <button class="action-btn btn-copy" onclick="copyLink()">
                <i class="fas fa-link"></i> Copier le lien d'invitation
            </button>
        </div>

        <div class="support-grid">
            <button class="action-btn btn-whatsapp" onclick="window.location.href='https://wa.me/22952761079'">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
            <button class="action-btn btn-telegram" onclick="window.location.href='https://t.me/+22952761079'">
                <i class="fab fa-telegram"></i> Telegram
            </button>
        </div>

        <button class="action-btn btn-logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Se déconnecter
        </button>
    </div>

    <div class="main-container">
        <div class="section-title">Mon Équipe & Gains</div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Membre</th>
                        <th>Date</th>
                        <th>Total Gagné</th>
                    </tr>
                </thead>
                <tbody id="referralTableBody">
                    <tr>
                        <td colspan="3" style="text-align:center; color:#999; padding:20px;">Chargement de l'équipe...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <p style="text-align:center; font-size:12px; color:#888; margin-top:15px; padding:0 20px;">
            * Le total inclut les bonus d'inscription et les commissions journalières déjà perçues pour ce membre.
        </p>
    </div>

    <div id="toast" class="toast">Lien copié dans le presse-papier !</div>

    <div class="navbar">
        <a href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="investissements.html"><i class="fas fa-chart-line"></i><span>Invest</span></a>
        <a href="wallet.html"><i class="fas fa-wallet"></i><span>Wallet</span></a>
        <a href="profil.html" class="active"><i class="fas fa-user"></i><span>Profil</span></a>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
        authDomain: "investapp-1818c.firebaseapp.com",
        projectId: "investapp-1818c",
        storageBucket: "investapp-1818c.firebasestorage.app",
        messagingSenderId: "416640904710",
        appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentReferralCode = "";

    auth.onAuthStateChanged(async user => {
        if(!user) return window.location.href = "login.html";

        const uid = user.uid;

        // 1. Charger les infos utilisateur
        const userDoc = await db.collection("users").doc(uid).get();
        if(userDoc.exists){
            const data = userDoc.data();
            document.getElementById("userPhone").innerText = 
                (data.countryCode || "") + " " + (data.phone || "Inconnu");
            
            currentReferralCode = data.myReferralCode || "---";
            document.getElementById("myReferralCode").innerText = currentReferralCode;
        }

        // 2. Charger la liste des filleuls et afficher (Méthode optimisée)
        loadReferrals(uid);
    });

    /**
     * Charge les filleuls en lisant directement la Map de la collection 'filleuls'
     * et utilise le champ 'totalEarned' pré-calculé.
     */
    async function loadReferrals(uid) {
        const tbody = document.getElementById("referralTableBody");
        
        // 1. Récupérer le document de parrainage (qui est une Map)
        const filleulsDoc = await db.collection("filleuls").doc(uid).get();
        
        // Vérifie si le document existe et s'il contient des données (le Map ne doit pas être vide)
        if(!filleulsDoc.exists || Object.keys(filleulsDoc.data()).length === 0){
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px;">Vous n'avez pas encore de filleuls.</td></tr>`;
            return;
        }

        const filleulsMap = filleulsDoc.data();
        
        // 2. Transformer la Map en une liste d'objets pour pouvoir la trier
        const filleulList = Object.keys(filleulsMap).map(childUid => ({
            uid: childUid,
            ...filleulsMap[childUid]
        })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // Tri par date décroissante

        tbody.innerHTML = "";

        for(const item of filleulList){
            try {
                const childUid = item.uid;
                // Récupération DIRECTE du champ totalEarned
                const totalEarned = item.totalEarned || 0; 
                
                // 3. Récupérer les infos du filleul pour l'affichage (phone)
                const childSnap = await db.collection("users").doc(childUid).get();
                if(childSnap.exists){
                    const childData = childSnap.data();
                    const phone = (childData.countryCode || "") + " " + (childData.phone || "Masqué");
                    
                    let dateStr = "-";
                    if(item.createdAt && item.createdAt.toDate){
                        dateStr = item.createdAt.toDate().toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'});
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>
                            <div style="font-weight:600;">${phone}</div>
                            <div style="font-size:11px; color:#aaa;">ID: ${childUid.substring(0,6)}...</div>
                        </td>
                        <td>${dateStr}</td>
                        <td class="money-col">+${totalEarned.toLocaleString()} F</td>
                    `;
                    tbody.appendChild(row);
                }
            } catch(e) {
                console.error("Erreur chargement ligne filleul", e);
            }
        }
    }

    function copyLink() {
        if(!currentReferralCode) return;
        const link = window.location.origin + "/register.html?code=" + currentReferralCode;
        
        navigator.clipboard.writeText(link).then(() => {
            showToast();
        }).catch(err => {
            prompt("Copiez votre lien :", link);
        });
    }

    function showToast() {
        const x = document.getElementById("toast");
        x.className = "toast show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function logout() {
        if(confirm("Voulez-vous vraiment vous déconnecter ?")){
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        }
    }
</script>

</body>
</html>
