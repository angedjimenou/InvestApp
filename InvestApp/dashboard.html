<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Sabot Invest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        padding-bottom: 100px; /* Espace pour la navbar */
    }

    /* --- Header Premium --- */
    .header-bg {
        background: linear-gradient(135deg, #6a0dad, #8e44ad);
        height: 160px;
        border-radius: 0 0 30px 30px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3);
    }
    .header-title {
        color: #fff;
        font-size: 24px;
        font-weight: bold;
        margin-top: -40px;
    }

    /* --- Carte Stats Principale --- */
    .user-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        width: 85%;
        max-width: 500px;
        margin: -60px auto 25px auto;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
        z-index: 10;
    }

    .user-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .user-phone { font-size: 14px; color: #777; font-weight: 600; }
    .user-balance { font-size: 22px; font-weight: 800; color: #4B0082; cursor: pointer; }

    .stats-row {
        display: flex;
        justify-content: space-between;
        text-align: center;
    }
    .stat-box { flex: 1; }
    .stat-val { font-size: 16px; font-weight: 700; color: #333; }
    .stat-lbl { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 2px; }
    .stat-box a { text-decoration: none; color: inherit; display: block; }

    /* --- Liste des Produits Compacte --- */
    .section-title {
        width: 90%; max-width: 500px; margin: 0 auto 10px auto;
        font-size: 16px; font-weight: 700; color: #444;
        display: flex; justify-content: space-between; align-items: center;
    }
    .section-title a { font-size: 12px; color: #6a0dad; text-decoration: none; }

    .products-list {
        width: 90%;
        max-width: 500px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .product-card {
        background: #fff;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(106, 13, 173, 0.05);
    }

    .prod-info { display: flex; flex-direction: column; gap: 4px; }
    .prod-name { font-size: 16px; font-weight: 700; color: #333; }
    .prod-details { font-size: 12px; color: #666; }
    .prod-price { font-weight: 700; color: #6a0dad; font-size: 14px; }

    .invest-btn {
        background: linear-gradient(135deg, #6a0dad, #8e44ad);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 8px 15px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(106, 13, 173, 0.2);
        transition: transform 0.1s;
    }
    .invest-btn:active { transform: scale(0.95); }

    /* --- Navbar --- */
    .navbar {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 600px;
        background: rgba(106, 13, 173, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 50px;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    .navbar a { color: #fff; font-size: 20px; text-decoration: none; display: flex; flex-direction: column; align-items: center; opacity: 0.7; transition: 0.3s; }
    .navbar a span { font-size: 10px; margin-top: 4px; font-weight: 500; }
    .navbar a.active { opacity: 1; color: #ffd700; transform: translateY(-2px); }

    /* --- Modals --- */
    .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; backdrop-filter:blur(5px); background-color: rgba(0,0,0,0.6);}
    .modal-content { 
        background-color: #fff; 
        margin: 30vh auto; 
        padding: 25px; 
        border-radius: 20px; 
        width: 85%; 
        max-width: 350px; 
        text-align: center; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: popUp 0.3s ease-out;
    }
    @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

    .modal h3 { margin-top:0; color:#6a0dad; font-size: 18px;}
    .modal p { color: #555; font-size: 14px; margin: 15px 0 25px 0; }
    
    .modal-btns { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; }
    .btn-yes { background: #6a0dad; color: #fff; }
    .btn-no { background: #eee; color: #333; }
    .btn-deposit { background: #ffd700; color: #000; }

</style>
</head>
<body>

    <div class="header-bg">
        <div class="header-title">Sabot Invest</div>
    </div>

    <div class="user-card">
        <div class="user-info-row">
            <div class="user-phone" id="phone">...</div>
            <div class="user-balance" id="balance" onclick="toggleBalance()">F ...</div>
        </div>
        <div class="stats-row">
            <div class="stat-box">
                <a href="mes_investissements.html">
                    <div class="stat-val" id="activeInvestments">0</div>
                    <div class="stat-lbl">Investissements</div>
                </a>
            </div>
            <div class="stat-box">
                <a href="revenus.html">
                    <div class="stat-val" id="dailyRevenue">0 F</div>
                    <div class="stat-lbl">Revenu Total/J</div>
                </a>
            </div>
        </div>
    </div>

    <div class="section-title">
        <span>Plans d'investissement</span>
        <a href="investissements.html">Voir tout <i class="fas fa-chevron-right"></i></a>
    </div>

    <div class="products-list" id="productsContainer">
        <p style="text-align:center; color:#999; margin-top:20px;">Chargement...</p>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmer</h3>
            <p id="modalText">Investir ?</p>
            <div class="modal-btns">
                <button class="modal-btn btn-no" id="confirmNo">Annuler</button>
                <button class="modal-btn btn-yes" id="confirmYes">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="insufficientModal" class="modal">
        <div class="modal-content">
            <h3>Solde Insuffisant</h3>
            <p>Veuillez recharger votre compte.</p>
            <div class="modal-btns">
                <button class="modal-btn btn-no" id="cancelDeposit">Fermer</button>
                <button class="modal-btn btn-deposit" id="goDeposit">Dépôt</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="investissements.html"><i class="fas fa-chart-line"></i><span>Invest</span></a>
        <a href="wallet.html"><i class="fas fa-wallet"></i><span>Wallet</span></a>
        <a href="profil.html"><i class="fas fa-user"></i><span>Profil</span></a>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
    authDomain: "investapp-1818c.firebaseapp.com",
    projectId: "investapp-1818c",
    storageBucket: "investapp-1818c.firebasestorage.app",
    messagingSenderId: "416640904710",
    appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// UI Elements
const phoneEl = document.getElementById("phone");
const balanceEl = document.getElementById("balance");
const activeInvestmentsEl = document.getElementById("activeInvestments");
const dailyRevenueEl = document.getElementById("dailyRevenue");
const productsContainer = document.getElementById("productsContainer");

// Modals
const confirmModal = document.getElementById("confirmModal");
const confirmYesBtn = document.getElementById("confirmYes");
const confirmNoBtn = document.getElementById("confirmNo");
const modalTitle = document.getElementById("modalTitle");
const modalText = document.getElementById("modalText");
const insufficientModal = document.getElementById("insufficientModal");
const goDepositBtn = document.getElementById("goDeposit");
const cancelDepositBtn = document.getElementById("cancelDeposit");

let balanceHidden = false;
let currentBalance = 0;
let selectedProduct = null;

// Handlers
goDepositBtn.onclick = () => window.location.href="wallet.html";
cancelDepositBtn.onclick = () => insufficientModal.style.display="none";
confirmNoBtn.onclick = () => confirmModal.style.display="none";

function toggleBalance() {
    balanceHidden = !balanceHidden;
    balanceEl.innerText = balanceHidden ? "F *****" : `F ${currentBalance.toLocaleString()}`;
}

// --- LOGIQUE D'ACHAT SÉCURISÉE ---
confirmYesBtn.onclick = async () => {
    if (!selectedProduct) return;
    
    confirmModal.style.display = "none";
    
    try {
        const user = auth.currentUser;
        if (!user) {
            alert("Erreur: Utilisateur non connecté.");
            return;
        }

        // 1. Récupérer le token d'authentification de l'utilisateur (Preuve d'identité)
        const idToken = await user.getIdToken(); 

        // 2. Préparer les données
        const payload = {
            idToken: idToken,
            productId: selectedProduct.id,
            productPrice: selectedProduct.price,
            dailyRevenue: selectedProduct.dailyRevenue,
            // Assurez-vous que durationDays est inclus, avec une valeur par défaut si besoin
            durationDays: selectedProduct.durationDays || 30 
        };
        
        // 3. Appel de la fonction Netlify sécurisée
        const response = await fetch('/.netlify/functions/achat_securise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        const result = await response.json();

        // 4. Gestion de la réponse du serveur
        if (response.ok && result.success) {
            alert(`✅ Achat réussi ! Votre nouveau solde est de ${result.newBalance.toLocaleString()} F`);
            window.location.reload(); 
        } else {
            // Afficher la modale "Solde Insuffisant" si le serveur renvoie cette erreur
            if (response.status === 403 && result.error === "Solde insuffisant pour cet achat.") {
                insufficientModal.style.display = "block";
            } else {
                alert(`❌ Échec de l'achat: ${result.error || 'Erreur inconnue.'}`);
            }
        }

    } catch(e) {
        console.error("Erreur lors de l'appel Netlify Function:", e);
        alert("❌ Erreur de connexion au serveur.");
    }
};

// --- INITIALISATION ---
auth.onAuthStateChanged((user) => {
    if(!user) return window.location.href = "login.html";
    loadUserData(user);
    loadProducts();
});

async function loadUserData(user) {
    const userRef = db.collection("users").doc(user.uid);
    userRef.onSnapshot(doc => { // Utilisation de onSnapshot pour mise à jour temps réel
        if(doc.exists) {
            const data = doc.data();
            currentBalance = data.balance || 0;
            if(!balanceHidden) balanceEl.innerText = `F ${currentBalance.toLocaleString()}`;
            
            phoneEl.innerText = `${data.countryCode} ${data.phone}`;

            // Calcul Revenu Total (Invest + Referral)
            const totalDaily = (data.daily?.invest || 0) + (data.daily?.referral || 0);
            dailyRevenueEl.innerText = `${totalDaily.toLocaleString()} F`;
        }
    });

    // Compteur Investissements Actifs
    const snap = await db.collection("investments")
        .where("userId", "==", user.uid)
        .where("status", "==", "active")
        .get();
    activeInvestmentsEl.innerText = snap.size;
}

async function loadProducts() {
    try {
        const snapshot = await db.collection("products").orderBy("price", "asc").get(); // Tri par prix pour dashboard
        productsContainer.innerHTML = "";
        
        snapshot.forEach(doc => {
            const prod = doc.data();
            prod.id = doc.id;
            
            const card = document.createElement("div");
            card.className = "product-card";
            // Layout Compact sans description
            card.innerHTML = `
                <div class="prod-info">
                    <div class="prod-name">${prod.name}</div>
                    <div class="prod-price">F ${prod.price.toLocaleString()}</div>
                    <div class="prod-details">Rev: F ${prod.dailyRevenue.toLocaleString()}/j • ${prod.durationDays}J</div>
                </div>
                <button class="invest-btn">Investir</button>
            `;
            
            card.querySelector("button").onclick = () => {
                selectedProduct = prod;
                modalTitle.innerText = prod.name;
                modalText.innerHTML = `Prix: <b>F ${prod.price.toLocaleString()}</b><br>Revenu/J: F ${prod.dailyRevenue.toLocaleString()}`;
                confirmModal.style.display = "block";
            };

            productsContainer.appendChild(card);
        });
    } catch(e) {
        console.error(e);
        productsContainer.innerHTML = `<p style="text-align:center;">Erreur chargement produits.</p>`;
    }
}
</script>
</body>
</html>
