<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boutique - Sabot Invest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        padding-bottom: 100px; /* Espace pour la navbar */
    }

    /* --- Header Premium --- */
    .header-bg {
        background: linear-gradient(135deg, #6a0dad, #8e44ad);
        height: 180px;
        border-radius: 0 0 30px 30px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3);
    }
    .header-title {
        color: #fff;
        font-size: 24px;
        font-weight: bold;
        margin-top: -50px;
    }

    /* --- Carte Stats Flottante (Spécifique Invest) --- */
    .stats-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        width: 85%;
        max-width: 500px;
        margin: -80px auto 25px auto;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        text-align: center;
			position: relative;
			z-index: 10;
    }

    .stat-item { display: flex; flex-direction: column; justify-content: center; }
    .stat-val { font-weight: 800; font-size: 16px; color: #4B0082; }
    .stat-label { font-size: 11px; color: #777; margin-top: 4px; text-transform: uppercase; }
    
    /* Style pour les liens cliquables dans les stats */
    .stat-val a {
        color: inherit; /* Conserve la couleur du .stat-val */
        text-decoration: none; /* Supprime le soulignement */
        display: block; /* Prend tout l'espace du div */
    }
    
    /* Séparateurs verticaux */
    .stat-item:not(:last-child) { border-right: 1px solid #eee; }

    /* --- Liste des Produits --- */
    .products-list {
        width: 90%;
        max-width: 500px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .product-card {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        border: 1px solid rgba(106, 13, 173, 0.05);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .product-card:active { transform: scale(0.98); }

    .prod-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .prod-name { font-size: 18px; font-weight: 700; color: #333; }
    .prod-desc { font-size: 13px; color: #666; font-style: italic; margin-top: 2px; }
    
    .prod-icon { 
        width: 40px; height: 40px; 
        background: #f3e5f5; color: #6a0dad; 
        border-radius: 10px; 
        display: flex; align-items: center; justify-content: center; font-size: 20px;
    }

    .prod-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        background: #fafafa;
        border-radius: 10px;
        padding: 10px;
        margin: 5px 0;
    }
    .grid-box { text-align: center; }
    .grid-lbl { font-size: 10px; color: #888; margin-bottom: 2px; }
    .grid-val { font-size: 14px; font-weight: bold; color: #333; }
    .grid-val.price { color: #d35400; }
    .grid-val.revenue { color: #27ae60; }

    .invest-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #6a0dad, #8e44ad);
        color: #fff;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(106, 13, 173, 0.2);
        transition: opacity 0.2s;
    }
    .invest-btn:hover { opacity: 0.9; }

    /* --- Navbar --- */
    .navbar {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 600px;
        background: rgba(106, 13, 173, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 50px;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    .navbar a { color: #fff; font-size: 20px; text-decoration: none; display: flex; flex-direction: column; align-items: center; opacity: 0.7; transition: 0.3s; }
    .navbar a span { font-size: 10px; margin-top: 4px; font-weight: 500; }
    .navbar a.active { opacity: 1; color: #ffd700; transform: translateY(-2px); }

    /* --- Modals (Style amélioré) --- */
    .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; backdrop-filter:blur(5px); background-color: rgba(0,0,0,0.6);}
    .modal-content { 
        background-color: #fff; 
        margin: 30vh auto; 
        padding: 25px; 
        border-radius: 20px; 
        width: 85%; 
        max-width: 350px; 
        text-align: center; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: popUp 0.3s ease-out;
    }
    @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

    .modal h3 { margin-top:0; color:#6a0dad; font-size: 20px;}
    .modal p { color: #555; font-size: 15px; margin: 15px 0 25px 0; }
    
    .modal-btns { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-yes { background: #6a0dad; color: #fff; }
    .btn-no { background: #eee; color: #333; }
    .btn-deposit { background: #ffd700; color: #000; }

</style>
</head>
<body>

    <div class="header-bg">
        <div class="header-title">Investissements</div>
    </div>

    <div class="stats-card">
        <div class="stat-item">
            <div class="stat-val" id="totalInvestments">
                <a href="mes_investissements.html">0</a>
            </div>
            <div class="stat-label">Actifs</div>
        </div>
        <div class="stat-item">
            <div class="stat-val" id="dailyRevenue">
                <a href="revenus.html">0 F</a>
            </div>
            <div class="stat-label">Revenu/J</div>
        </div>
        <div class="stat-item">
            <div class="stat-val" id="creditedDaily">0 F</div>
            <div class="stat-label">Total Gagné</div>
        </div>
    </div>

    <div class="products-list" id="productsContainer">
        <p style="text-align:center; color:#999; margin-top:20px;">Chargement des produits...</p>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmer</h3>
            <p id="modalText">Voulez-vous investir ?</p>
            <div class="modal-btns">
                <button class="modal-btn btn-no" id="confirmNo">Annuler</button>
                <button class="modal-btn btn-yes" id="confirmYes">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="insufficientModal" class="modal">
        <div class="modal-content">
            <h3>Solde Insuffisant</h3>
            <p>Vous n'avez pas assez de fonds pour cet investissement.</p>
            <div class="modal-btns">
                <button class="modal-btn btn-no" id="cancelDeposit">Fermer</button>
                <button class="modal-btn btn-deposit" id="goDeposit">Recharger</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <a href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="investissements.html" class="active"><i class="fas fa-chart-line"></i><span>Invest</span></a>
        <a href="wallet.html"><i class="fas fa-wallet"></i><span>Wallet</span></a>
        <a href="profil.html"><i class="fas fa-user"></i><span>Profil</span></a>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
const firebaseConfig = {
    apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
    authDomain: "investapp-1818c.firebaseapp.com",
    projectId: "investapp-1818c",
    storageBucket: "investapp-1818c.firebasestorage.app",
    messagingSenderId: "416640904710",
    appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elements UI
const container = document.getElementById("productsContainer");
const totalInvestmentsDiv = document.getElementById("totalInvestments").querySelector('a'); 
const dailyRevenueDiv = document.getElementById("dailyRevenue").querySelector('a');     
const creditedDailyDiv = document.getElementById("creditedDaily");

// Elements Modal
const confirmModal = document.getElementById("confirmModal");
const confirmYesBtn = document.getElementById("confirmYes");
const confirmNoBtn = document.getElementById("confirmNo");
const modalTitle = document.getElementById("modalTitle");
const modalText = document.getElementById("modalText");

const insufficientModal = document.getElementById("insufficientModal");
const goDepositBtn = document.getElementById("goDeposit");
const cancelDepositBtn = document.getElementById("cancelDeposit");

// Variables globales
let selectedProduct = null;

// Gestion Modals
goDepositBtn.onclick = () => { window.location.href="wallet.html"; };
cancelDepositBtn.onclick = () => { insufficientModal.style.display="none"; };
confirmNoBtn.onclick = () => { confirmModal.style.display="none"; };

// --- LOGIQUE D'ACHAT SÉCURISÉE (Appel Netlify Function) ---
confirmYesBtn.onclick = async () => {
    if (!selectedProduct) return;
    
    confirmModal.style.display = "none";
    
    try {
        const user = auth.currentUser;
        if (!user) {
            alert("Erreur: Utilisateur non connecté.");
            return;
        }

        // 1. Récupérer le token d'authentification (Preuve d'identité)
        const idToken = await user.getIdToken(); 

        // 2. Préparer les données
        const payload = {
            idToken: idToken,
            productId: selectedProduct.id,
            productPrice: selectedProduct.price,
            dailyRevenue: selectedProduct.dailyRevenue,
            durationDays: selectedProduct.durationDays || 30 
        };
        
        // 3. Appel de la fonction Netlify sécurisée
        const response = await fetch('/.netlify/functions/achat_securise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        const result = await response.json();

        // 4. Gestion de la réponse du serveur
        if (response.ok && result.success) {
            alert(`✅ Achat réussi ! Votre nouveau solde est de ${result.newBalance.toLocaleString()} F`);
            window.location.reload(); 
        } else {
            // Afficher la modale "Solde Insuffisant" si le serveur renvoie l'erreur 403
            if (response.status === 403 && result.error === "Solde insuffisant pour cet achat.") {
                insufficientModal.style.display = "block";
            } else {
                alert(`❌ Échec de l'achat: ${result.error || 'Erreur inconnue.'}`);
            }
        }

    } catch(e) {
        console.error("Erreur lors de l'appel Netlify Function:", e);
        alert("❌ Erreur de connexion au serveur.");
    }
};

// --- CHARGEMENT INITIAL ---
auth.onAuthStateChanged(async (user)=>{
    if(!user) return window.location.href="login.html";
    
    const userRef = db.collection("users").doc(user.uid);
    const userSnap = await userRef.get();
    
    if(userSnap.exists){
        const data = userSnap.data();

        // Compter les investissements
        const investmentsSnapshot = await db.collection("investments")
            .where("userId", "==", user.uid)
            .where("status", "==", "active") // Compter seulement les actifs
            .get();
        const investmentCount = investmentsSnapshot.size;
        
        const totalDaily = (data.daily?.invest || 0);

        // Mise à jour UI Stats avec les liens
        totalInvestmentsDiv.innerText = investmentCount;
        dailyRevenueDiv.innerText = `${totalDaily.toLocaleString()} F`;
        creditedDailyDiv.innerText = `${(data.totalRevenue?.invest || 0).toLocaleString()} F`;
    }

    // Charger et Afficher Produits
    loadProducts(user);
});

async function loadProducts(user) {
    try {
        const snapshot = await db.collection("products").get();
        let products = [];
        snapshot.forEach(doc => { 
            const p = doc.data(); 
            p.id = doc.id; 
            products.push(p); 
        });

        // Tri logique (Regex Lv) conservé
        products.sort((a,b) => {
            const getLv = (name) => parseInt((name.match(/Lv(\d+)/)||[0,0])[1]);
            return getLv(a.name) - getLv(b.name);
        });

        container.innerHTML = "";

        products.forEach(prod => {
            const card = document.createElement("div");
            card.className = "product-card";
            
            card.innerHTML = `
                <div class="prod-header">
                    <div>
                        <div class="prod-name">${prod.name}</div>
                        <div class="prod-desc">${prod.description || 'Machine de minage haute performance'}</div>
                    </div>
                    <div class="prod-icon"><i class="fas fa-server"></i></div>
                </div>

                <div class="prod-grid">
                    <div class="grid-box">
                        <div class="grid-lbl">Prix</div>
                        <div class="grid-val price">F ${prod.price.toLocaleString()}</div>
                    </div>
                    <div class="grid-box">
                        <div class="grid-lbl">Revenu/J</div>
                        <div class="grid-val revenue">F ${prod.dailyRevenue.toLocaleString()}</div>
                    </div>
                    <div class="grid-box">
                        <div class="grid-lbl">Durée</div>
                        <div class="grid-val">${prod.durationDays} J</div>
                    </div>
                </div>

                <button class="invest-btn">Investir maintenant</button>
            `;

            // Clic sur "Investir"
            card.querySelector("button").addEventListener("click", () => openConfirm(prod));
            container.appendChild(card);
        });
    } catch(e) {
        console.error(e);
        container.innerHTML = `<p style="text-align:center; color:red;">Erreur lors du chargement.</p>`;
    }
}

function openConfirm(prod){
    selectedProduct = prod;
    modalTitle.innerText = prod.name;
    modalText.innerHTML = `Prix : <b>F ${prod.price.toLocaleString()}</b><br>Revenu/J : <b>F ${prod.dailyRevenue.toLocaleString()}</b><br>Confirmez-vous l'achat ?`;
    confirmModal.style.display = "block";
}
</script>


</body>
</html>
