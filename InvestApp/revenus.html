<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenus Journaliers - Sabot Invest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        /* --- Header Premium avec bouton retour --- */
        .header-bg {
            background: linear-gradient(135deg, #6a0dad, #8e44ad);
            height: 120px;
            border-radius: 0 0 30px 30px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3);
        }
        .header-title {
            color: #fff;
            font-size: 22px;
            font-weight: bold;
        }
        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #fff;
            cursor: pointer;
        }

        /* --- Carte Stats Totales Flottante --- */
        .stats-card {
            background: #fff;
            width: 85%;
            max-width: 500px;
            margin: -40px auto 25px auto;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            z-index: 10;
        }
        .stats-card h4 {
            color: #777;
            font-size: 14px;
            margin-top: 0;
            margin-bottom: 5px;
        }
        .total-revenue {
            font-size: 28px;
            font-weight: 800;
            color: #4B0082; /* Violet foncé */
        }

        /* --- Contenu Principal & Onglets --- */
        .main-container {
            width: 90%;
            max-width: 500px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            background: #e9e9e9;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .tabs button {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            transition: all 0.2s;
        }
        .tabs button.active {
            background: #6a0dad;
            color: #fff;
            box-shadow: 0 4px 8px rgba(106, 13, 173, 0.3);
        }

        .tab-content { display: none; }
        .tab-content.visible { display: block; }
        
        /* --- Style des Éléments de la Liste --- */
        .revenue-item {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #6a0dad;
        }
        .item-left { font-size: 15px; font-weight: 600; color: #333; }
        .item-right { 
            font-size: 16px; 
            font-weight: 800; 
            color: #27ae60; /* Vert pour les gains */
        }
        .item-meta { font-size: 12px; color: #999; margin-top: 2px; }

        /* Loader */
        .loader { text-align: center; padding: 20px; color: #6a0dad; }
    </style>
</head>
<body>

    <div class="header-bg">
        <i class="fas fa-arrow-left back-btn" onclick="window.history.back()"></i>
        <div class="header-title">Détail des Revenus</div>
    </div>

    <div class="stats-card">
        <h4>Revenu Journalier Actuel</h4>
        <div class="total-revenue" id="totalDailyRevenue">0 F</div>
    </div>

    <div class="main-container">
        
        <div class="tabs">
            <button id="tabInvestBtn" class="active">Investissement</button>
            <button id="tabReferralBtn">Parrainage</button>
        </div>

        <div id="investTab" class="tab-content visible">
            <div class="loader" id="investLoader">Chargement des investissements...</div>
            </div>

        <div id="referralTab" class="tab-content">
            <p class="revenue-item" style="border-left: 5px solid #27ae60; margin-bottom: 15px;">
                <span class="item-left">Total Revenu Parrainage</span>
                <span class="item-right" id="totalReferralRevenue">0 F</span>
            </p>
            <h4 style="color:#6a0dad; border-bottom:1px solid #eee; padding-bottom:10px; margin-top:20px;">Détail Niveau 1 (1% du revenu total de chaque)</h4>
            <div class="loader" id="referralLoader">Chargement des filleuls...</div>
            </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
            authDomain: "investapp-1818c.firebaseapp.com",
            projectId: "investapp-1818c",
            storageBucket: "investapp-1818c.firebasestorage.app",
            messagingSenderId: "416640904710",
            appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Éléments UI
        const totalDailyRevenueDiv = document.getElementById("totalDailyRevenue");
        const totalReferralRevenueDiv = document.getElementById("totalReferralRevenue");
        const investContentDiv = document.getElementById("investTab");
        const referralContentDiv = document.getElementById("referralTab");
        const investLoader = document.getElementById("investLoader");
        const referralLoader = document.getElementById("referralLoader");
        const tabInvestBtn = document.getElementById("tabInvestBtn");
        const tabReferralBtn = document.getElementById("tabReferralBtn");

        // --- GESTION DES ONGLET ---
        function switchTab(tabName) {
            // Désactiver tous les contenus
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('.tabs button').forEach(el => el.classList.remove('active'));

            // Activer le contenu et le bouton correspondant
            if (tabName === 'invest') {
                investContentDiv.classList.add('visible');
                tabInvestBtn.classList.add('active');
                // Charger si le contenu n'a pas été chargé avant (contient toujours le loader)
                if (investContentDiv.innerHTML.includes("Chargement des investissements...")) loadInvestmentRevenue(auth.currentUser.uid);
            } else if (tabName === 'referral') {
                referralContentDiv.classList.add('visible');
                tabReferralBtn.classList.add('active');
                // Charger si le contenu n'a pas été chargé avant (contient toujours le loader)
                // Note : On ne peut pas se baser uniquement sur le loader car le loader est au début du contenu
                if (referralContentDiv.querySelector('#referralLoader')) loadReferralRevenue(auth.currentUser.uid);
            }
        }

        tabInvestBtn.onclick = () => switchTab('invest');
        tabReferralBtn.onclick = () => switchTab('referral');
        
        // --- CHARGEMENT DES REVENUS D'INVESTISSEMENT ---
        async function loadInvestmentRevenue(uid) {
            investContentDiv.innerHTML = ""; // Vider pour retirer le loader
            
            try {
                const snap = await db.collection("investments")
                    .where("userId", "==", uid)
                    .where("status", "==", "active")
                    .get();

                if (snap.empty) {
                    investContentDiv.innerHTML = "<p class='loader'>Aucun investissement actif.</p>";
                    return;
                }

                snap.forEach(doc => {
                    const t = doc.data();
                    const item = document.createElement("div");
                    item.className = "revenue-item";
                    
                    const endDate = t.endDate?.toDate ? t.endDate.toDate().toLocaleDateString() : 'N/A';
                    
                    item.innerHTML = `
                        <div>
                            <div class="item-left">${t.productName || 'Investissement'}</div>
                            <div class="item-meta">Jusqu'au ${endDate}</div>
                        </div>
                        <div class="item-right">+ ${t.dailyRevenue.toLocaleString()} F</div>
                    `;
                    investContentDiv.appendChild(item);
                });
            } catch (e) {
                console.error("Erreur chargement investissements:", e);
                investContentDiv.innerHTML = "<p class='loader' style='color:red;'>Erreur lors du chargement des données.</p>";
            }
        }

        // --- CHARGEMENT DES REVENUS DE PARRAINAGE (CORRIGÉ) ---
        async function loadReferralRevenue(uid) {
            referralContentDiv.querySelector('#referralLoader').style.display = 'none'; // Cacher le loader temporaire
            
            // Créer un conteneur pour la liste des filleuls
            const listContainer = document.createElement("div");

            try {
                // 1. Charger les filleuls directs (Niveau 1)
                const filleulsSnap = await db.collection("users")
                    .where("referrerUid", "==", uid)
                    .get();

                if (filleulsSnap.empty) {
                    listContainer.innerHTML = "<p class='loader'>Aucun filleul de niveau 1 pour le moment.</p>";
                } else {
                    let hasInvestedFilleul = false;
                    filleulsSnap.forEach(doc => {
                        const u = doc.data();
                        
                        // Afficher uniquement ceux qui ont fait un premier investissement (pour pertinence)
                        if (u.firstInvestmentDone) {
                            hasInvestedFilleul = true;
                            const phone = `${u.countryCode || ''} ${u.phone || 'Utilisateur ID: ' + doc.id.substring(0, 5)}`;
                            
                            // ----------------------------------------------------------------------
                            // NOUVEAU CALCUL VALIDÉ :
                            // Contribution = (1% de daily.invest arrondi) + (100% de daily.referral)
                            // ----------------------------------------------------------------------
                            const filleulInvestDaily = (u.daily?.invest || 0); // Pour la clarté
                            const filleulReferralDaily = (u.daily?.referral || 0); // Pour la clarté

                            // 1. Calcul de la commission de 1% sur l'investissement personnel du filleul
                            const commissionInvest = Math.round(filleulInvestDaily * 0.01); 

                            // 2. La commission totale affichée est la commission Invest + 100% du Referral (qui est le gain de la cascade)
                            const userReferralCommission = commissionInvest + filleulReferralDaily;
                            
                            // Calcul du total quotidien du filleul (pour l'affichage en meta)
                            const filleulTotalDaily = filleulInvestDaily + filleulReferralDaily; 

                            const item = document.createElement("div");
                            item.className = "revenue-item";
                            item.style.borderLeftColor = '#8e44ad'; // Couleur différente pour referral

                            item.innerHTML = `
                                <div>
                                    <div class="item-left">${phone}</div>
                                    
                           </div>
                                <div class="item-right">
                                    + ${userReferralCommission.toLocaleString()} F
                                </div>
                            `;
                            listContainer.appendChild(item);
                        }
                    });

                    if (!hasInvestedFilleul) {
                        listContainer.innerHTML = "<p class='loader'>Vos filleuls de niveau 1 n'ont pas encore investi.</p>";
                    }
                }
                
                // Remplacer le loader par la liste
                const referralLoaderElement = referralContentDiv.querySelector('#referralLoader');
                if (referralLoaderElement) {
                    referralContentDiv.removeChild(referralLoaderElement);
                }
                referralContentDiv.appendChild(listContainer);
                
            } catch (e) {
                console.error("Erreur chargement filleuls:", e);
                // Utiliser la variable listContainer pour afficher l'erreur
                listContainer.innerHTML = "<p class='loader' style='color:red;'>Erreur lors du chargement des données de parrainage.</p>";
                // S'assurer que le loader est retiré avant d'ajouter le message d'erreur
                const referralLoaderElement = referralContentDiv.querySelector('#referralLoader');
                if (referralLoaderElement) {
                    referralContentDiv.removeChild(referralLoaderElement);
                }
                referralContentDiv.appendChild(listContainer);
            }
        }

        // --- DÉMARRAGE DE LA PAGE ---
        auth.onAuthStateChanged(async (user) => {
            if (!user) return window.location.href = "login.html";

            const userRef = db.collection("users").doc(user.uid);
            try {
                const userSnap = await userRef.get();
                if (userSnap.exists) {
                    const data = userSnap.data();
                    const dailyInvest = data.daily?.invest || 0;
                    const dailyReferral = data.daily?.referral || 0;
                    const totalDaily = dailyInvest + dailyReferral;

                    // Mise à jour de la carte totale
                    totalDailyRevenueDiv.innerText = `${totalDaily.toLocaleString()} F`;
                    totalReferralRevenueDiv.innerText = `${dailyReferral.toLocaleString()} F`;
                    
                    // Chargement du premier onglet (Investissement)
                    // On appelle la fonction ici au démarrage pour le premier onglet actif
                    loadInvestmentRevenue(user.uid);
                } else {
                    window.location.href = "login.html";
                }
            } catch (e) {
                console.error("Erreur d'authentification ou chargement user:", e);
                alert("Une erreur est survenue. Veuillez vous reconnecter.");
                window.location.href = "login.html";
            }
        });
    </script>
</body>
</html>
