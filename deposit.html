<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>D√©p√¥t - Sabot Invest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
/* === DESIGN inchang√© === */
body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding-bottom: 30px; }
.header-bg { background: linear-gradient(135deg, #6a0dad, #8e44ad); height: 100px; border-radius: 0 0 25px 25px; position: relative; display: flex; justify-content: center; align-items: center; box-shadow: 0 3px 10px rgba(106, 13, 173, 0.2);}
.header-title { color: #fff; font-size: 20px; font-weight: bold; padding: 0 60px; text-align: center;}
.back-btn { position: absolute; left: 15px; top: 35px; font-size: 20px; color: #fff; z-index: 10;}
.form-container { width: 95%; max-width: 350px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);}
label { display: block; font-weight: 600; margin-bottom: 6px; color: #4B0082; font-size: 14px;}
input[type="number"], select { width: 100%; padding: 10px 12px; margin-bottom: 18px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px;}
button { width: 100%; padding: 12px; border: none; border-radius: 6px; background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s;}
button:disabled { background: #ccc; cursor: not-allowed;}
.info-box { padding: 10px; background-color: #f3e5f5; border: 1px solid #e0b0ff; color: #4B0082; border-radius: 6px; margin-bottom: 15px; font-size: 14px; line-height: 1.4;}
.error { color: #e74c3c; margin-bottom: 15px; display: none; font-weight: 600; text-align: center;}
#noMethodsMessage { text-align: center; color: #e74c3c; font-weight: bold; margin-top: 10px;}
</style>
</head>
<body>

<div class="header-bg">
    <a href="wallet.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div class="header-title">Effectuer un D√©p√¥t</div>
</div>

<div class="form-container">
    <div class="info-box">
        S√©lectionnez une m√©thode de paiement et confirmez le montant. Le paiement sera initi√© via FedaPay.
    </div>

    <form id="depositForm">
        <div id="error" class="error"></div>
        
        <label for="paymentMethod">Moyen de Paiement Enregistr√©</label>
        <select id="paymentMethod" required>
            <option value="">Chargement des m√©thodes...</option>
        </select>
        <div id="noMethodsMessage" style="display: none;">
            Aucune m√©thode trouv√©e. <a href="add_payment_method.html">Ajoutez-en une.</a>
        </div>

        <label for="amount">Montant √† D√©poser (F)</label>
        <input type="number" id="amount" placeholder="Minimum 500 F" min="500" required>

        <div id="feeSummary" class="info-box" style="display: none; background-color: #fff8e1; border-color: #ffecb3;">
            <p style="margin: 0; font-weight: 600;">R√©capitulatif de la transaction :</p>
            <ul style="list-style: none; padding: 0; margin-top: 5px; font-size: 13px;">
                <li>Montant qui sera cr√©dit√© √† votre Wallet : <span id="netAmount" style="float:right; font-weight: 700; color:#27ae60;"></span></li>
                <li>Frais de transaction FedaPay (env. 1.83%) : <span id="depositFees" style="float:right; color:#e74c3c;"></span></li>
                <li style="border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 5px;">
                    Montant total d√©bit√© de votre compte Mobile Money : <span id="chargedAmount" style="float:right; font-weight: 700; color:#4B0082;"></span>
                </li>
            </ul>
        </div>
        <button type="submit" id="depositBtn" disabled>Confirmer le D√©p√¥t</button>
    </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
    authDomain: "investapp-1818c.firebaseapp.com",
    projectId: "investapp-1818c",
    storageBucket: "investapp-1818c.firebasestorage.app",
    messagingSenderId: "416640904710",
    appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- CONSTANTE DE GESTION DES FRAIS ---
const FEDAPAY_RATE = 0.0183; // 1.83% du montant net
const MIN_AMOUNT = 500;

auth.onAuthStateChanged(user => {
    if(!user) return window.location.href='login.html';
    loadPaymentMethods(user.uid);
});

async function loadPaymentMethods(uid) {
    const select = document.getElementById("paymentMethod");
    const noMethods = document.getElementById("noMethodsMessage");
    const depositBtn = document.getElementById("depositBtn");
    select.innerHTML = '<option value="">S√©lectionnez un moyen de paiement</option>';
    
    try {
        const methodsRef = db.collection("users").doc(uid).collection("payment_methods");
        const snapshot = await methodsRef.get();

        if (snapshot.empty) {
            noMethods.style.display = 'block';
            depositBtn.disabled = true;
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const option = document.createElement('option');
            option.value = doc.id; 
            option.dataset.operator = data.operator;
            option.dataset.phone = data.fullPhoneNumber;
            option.textContent = `${data.nickname} (${data.operator.toUpperCase().replace(/_/g, ' ')})`;
            select.appendChild(option);
        });
        
        depositBtn.disabled = true; 

    } catch (error) {
        console.error("Erreur chargement m√©thodes:", error);
        select.innerHTML = '<option value="">Erreur de chargement</option>';
        depositBtn.disabled = true;
    }
}

/**
 * Calcule le montant total que le client paiera, en sachant que FedaPay applique les frais sur le montant que NOUS demandons.
 * @param {number} netAmount Le montant que nous demandons √† FedaPay (et que nous recevrons).
 * @param {number} rate Le taux de frais (en d√©cimal, ex: 0.0183).
 * @returns {object} {chargedAmount, fees, netAmount}
 */
function calculateCharge(netAmount, rate) {
    if (netAmount <= 0) {
        return { chargedAmount: 0, fees: 0, netAmount: 0 };
    }
    
    // Si FedaPay ajoute 1.83% au montant que nous demandons (netAmount)
    const fees = netAmount * rate;
    const chargedAmountFloat = netAmount + fees;

    // Arrondi √† l'entier sup√©rieur pour une estimation conservatrice et claire pour l'utilisateur
    const chargedAmount = Math.ceil(chargedAmountFloat); 

    // Les frais r√©els que le client paie
    const actualFees = chargedAmount - netAmount; 

    return {
        chargedAmount: chargedAmount,
        fees: actualFees,
        netAmount: netAmount
    };
}

// --- √âCOUTEUR DE SAISIE DE MONTANT ---
document.getElementById("amount").addEventListener("input", function() {
    // Le montant saisi est le montant net que l'utilisateur recevra
    const netAmount = parseInt(this.value); 
    const errorDiv = document.getElementById("error");
    const feeSummaryDiv = document.getElementById("feeSummary");
    const depositBtn = document.getElementById("depositBtn");
    const methodSelected = document.getElementById("paymentMethod").value !== "";

    errorDiv.style.display = "none";
    feeSummaryDiv.style.display = "none";
    depositBtn.disabled = true;

    if (isNaN(netAmount) || netAmount < MIN_AMOUNT) {
        return;
    }

    // Le bouton peut √™tre activ√© uniquement si une m√©thode est s√©lectionn√©e
    if (methodSelected) {
        const result = calculateCharge(netAmount, FEDAPAY_RATE);
        
        // Affichage du r√©sum√©
        document.getElementById("netAmount").textContent = `${netAmount.toLocaleString()} F`;
        document.getElementById("depositFees").textContent = `${result.fees.toLocaleString()} F`;
        document.getElementById("chargedAmount").textContent = `${result.chargedAmount.toLocaleString()} F`;
        
        feeSummaryDiv.style.display = "block";
        depositBtn.disabled = false;
    } else {
        errorDiv.innerText = "Veuillez s√©lectionner un moyen de paiement.";
        errorDiv.style.display = "block";
    }
});


// --- GESTIONNAIRE DE SOUMISSION MODIFI√â (ENVOIE LE MONTANT NET) ---
document.getElementById("depositForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;

    // C'est le montant NET que nous voulons recevoir et que nous envoyons √† FedaPay
    const netAmount = parseInt(document.getElementById("amount").value); 
    const selectedOption = document.getElementById("paymentMethod").options[document.getElementById("paymentMethod").selectedIndex];
    const methodId = selectedOption.value;
    const operator = selectedOption.dataset.operator;
    const errorDiv = document.getElementById("error");
    const depositBtn = document.getElementById("depositBtn");

    if (netAmount < MIN_AMOUNT || !methodId) {
        errorDiv.innerText = "Veuillez v√©rifier le montant et la m√©thode de paiement.";
        errorDiv.style.display = "block";
        return;
    }

    depositBtn.disabled = true;
    depositBtn.innerText = "Traitement du d√©p√¥t...";

    try {
        const idToken = await user.getIdToken();
        const payload = {
            idToken: idToken,
            uid: user.uid,
            paymentMethodId: methodId,
            // üìå ENVOI DU MONTANT NET. FedaPay ajoutera lui-m√™me les 1.83% au client.
            amount: netAmount, 
            currencyIso: "XOF"
        };
        
        const response = await fetch('/.netlify/functions/deposit_request', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert(`‚úÖ D√©p√¥t de ${netAmount.toLocaleString()} F initi√©. Veuillez confirmer le paiement sur votre t√©l√©phone. (Frais FedaPay appliqu√©s au d√©bit)`);
            window.location.href = "wallet.html"; 
        } else {
            errorDiv.innerText = result.error || "Erreur lors de la requ√™te de d√©p√¥t (Serveur).";
            errorDiv.style.display = "block";
        }

    } catch (err) {
        console.error("Erreur D√©p√¥t:", err);
        errorDiv.innerText = "Erreur de connexion au serveur.";
        errorDiv.style.display = "block";
    } finally {
        depositBtn.disabled = false;
        depositBtn.innerText = "Confirmer le D√©p√¥t";
    }
});
</script>

</body>
</html>