<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Retrait - Sabot Invest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        padding-bottom: 30px; 
    }
    .header-bg {
        background: linear-gradient(135deg, #6a0dad, #8e44ad);
        height: 100px;
        border-radius: 0 0 25px 25px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 3px 10px rgba(106, 13, 173, 0.2);
    }
    .header-title {
        color: #fff;
        font-size: 20px;
        font-weight: bold;
        padding: 0 60px; 
        text-align: center;
    }
    .back-btn {
        position: absolute;
        left: 15px; 
        top: 35px;
        font-size: 20px;
        color: #fff;
        z-index: 10;
    }
    .form-container {
        width: 95%; 
        max-width: 350px; 
        margin: 30px auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: #4B0082;
        font-size: 14px;
    }
    input[type="number"], select {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 18px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 15px;
    }
    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .info-box {
        padding: 10px;
        background-color: #f3e5f5;
        border: 1px solid #e0b0ff;
        color: #4B0082;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.4;
        text-align: center;
    }
    .balance-display {
        font-size: 18px;
        font-weight: bold;
        color: #27ae60;
        margin-bottom: 15px;
        text-align: center;
    }
    .error {
        color: #e74c3c;
        margin-bottom: 15px;
        display: none;
        font-weight: 600;
        text-align: center;
    }
    #noMethodsMessage {
        text-align: center;
        color: #e74c3c;
        font-weight: bold;
        margin-top: 10px;
    }
</style>
</head>
<body>

<div class="header-bg">
    <a href="wallet.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div class="header-title">Demande de Retrait</div>
</div>

<div class="form-container">
    <div class="info-box">
        Montant minimum de retrait: <strong>1000 F</strong>. Les frais de réseau sont de <strong>15%</strong>.
    </div>
    
    <div class="balance-display">
        Solde Disponible: <span id="currentBalance">... F</span>
    </div>

    <form id="withdrawForm">
        <div id="error" class="error"></div>
        
        <label for="paymentMethod">Moyen de Paiement pour Recevoir</label>
        <select id="paymentMethod" required>
            <option value="">Chargement des méthodes...</option>
        </select>
        <div id="noMethodsMessage" style="display: none;">
            Aucune méthode trouvée. <a href="add_payment_method.html">Ajoutez-en une.</a>
        </div>

        <label for="amount">Montant à Retirer (F)</label>
        <input type="number" id="amount" placeholder="Minimum 1000 F" min="1000" required>

        <div class="info-box" id="feePreview" style="display:none;">
            Frais (15%): <span id="feeAmount">0</span> F<br>
            Montant Net: <span id="netAmount">0</span> F
        </div>

        <button type="submit" id="withdrawBtn" disabled>Demander le Retrait</button>
    </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDya4uWqXv_R7qjrBT4f3YlUr6mMarjgYo",
    authDomain: "investapp-1818c.firebaseapp.com",
    projectId: "investapp-1818c",
    storageBucket: "investapp-1818c.firebasestorage.app",
    messagingSenderId: "416640904710",
    appId: "1:416640904710:web:a810b7ed5b8bd41d9c9d87"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let userBalance = 0;

auth.onAuthStateChanged(user => {
    if(!user) return window.location.href='login.html';
    loadUserData(user.uid);
    loadPaymentMethods(user.uid);
});

async function loadUserData(uid) {
    const balanceSpan = document.getElementById("currentBalance");
    try {
        const doc = await db.collection("users").doc(uid).get();
        if(doc.exists){
            userBalance = doc.data().balance || 0;
            balanceSpan.innerText = userBalance.toLocaleString('fr-FR') + ' F';
        }
    } catch(e){
        console.error(e);
        balanceSpan.innerText = 'Erreur';
    }
}

async function loadPaymentMethods(uid){
    const select = document.getElementById("paymentMethod");
    const noMethods = document.getElementById("noMethodsMessage");
    const withdrawBtn = document.getElementById("withdrawBtn");

    select.innerHTML = '<option value="">Sélectionnez un moyen de paiement</option>';

    try {
        const snapshot = await db.collection("users").doc(uid).collection("payment_methods").get();
        if(snapshot.empty){
            noMethods.style.display='block';
            withdrawBtn.disabled=true;
            return;
        }
        snapshot.forEach(doc=>{
            const data = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.dataset.operator = data.operator;
            option.dataset.phone = data.fullPhoneNumber;
            option.textContent = `${data.nickname} (${data.operator.toUpperCase().replace(/_/g,' ')})`;
            select.appendChild(option);
        });
        withdrawBtn.disabled = true; // activation via montant
    } catch(e){
        console.error(e);
        select.innerHTML = '<option value="">Erreur de chargement</option>';
        withdrawBtn.disabled = true;
    }
}

const amountInput = document.getElementById('amount');
const feePreview = document.getElementById('feePreview');
const feeAmountSpan = document.getElementById('feeAmount');
const netAmountSpan = document.getElementById('netAmount');

amountInput.addEventListener('input', () => {
    const amount = parseInt(amountInput.value) || 0;
    if(amount >= 1000 && amount <= userBalance){
        const fee = Math.floor(amount * 0.15);
        const net = amount - fee;
        feeAmountSpan.innerText = fee.toLocaleString('fr-FR');
        netAmountSpan.innerText = net.toLocaleString('fr-FR');
        feePreview.style.display='block';
        withdrawBtn.disabled=false;
    } else {
        feePreview.style.display='none';
        withdrawBtn.disabled=true;
    }
});

document.getElementById("withdrawForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const user = auth.currentUser;
    if(!user) return;

    const amount = parseInt(amountInput.value);
    const selectedOption = document.getElementById("paymentMethod").selectedOptions[0];
    const methodId = selectedOption.value;

    const errorDiv = document.getElementById("error");
    errorDiv.style.display = 'none';

    if(!methodId){
        errorDiv.innerText = "Veuillez sélectionner un moyen de paiement valide.";
        errorDiv.style.display = "block";
        return;
    }

    withdrawBtn.disabled=true;
    withdrawBtn.innerText="Envoi de la demande...";

    try{
        const payload = { uid: user.uid, methodId, amount };
        const response = await fetch('/.netlify/functions/withdraw_request', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });
        const result = await response.json();
        if(response.ok && result.success){
            alert(`✅ Retrait demandé : ${amount.toLocaleString()} F\nFrais : ${result.fee.toLocaleString()} F\nNet reçu : ${result.netAmount.toLocaleString()} F`);
            window.location.href="wallet.html";
        } else {
            errorDiv.innerText = result.error || "Erreur lors de la requête de retrait.";
            errorDiv.style.display = "block";
        }
    } catch(err){
        console.error(err);
        errorDiv.innerText="Erreur de connexion au serveur.";
        errorDiv.style.display="block";
    } finally {
        withdrawBtn.disabled=false;
        withdrawBtn.innerText="Demander le Retrait";
    }
});
</script>
</body>
</html>
